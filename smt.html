<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>SMT - The Act Book</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="language.html"><strong aria-hidden="true">1.</strong> Language Reference</a></li><li class="chapter-item expanded "><a href="backends.html"><strong aria-hidden="true">2.</strong> Backends</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="smt.html" class="active"><strong aria-hidden="true">2.1.</strong> SMT</a></li><li class="chapter-item expanded "><a href="coq.html"><strong aria-hidden="true">2.2.</strong> Coq</a></li><li class="chapter-item expanded "><a href="hevm.html"><strong aria-hidden="true">2.3.</strong> Hevm</a></li></ol></li><li class="chapter-item expanded "><a href="internals.html"><strong aria-hidden="true">3.</strong> Internals</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Act Book</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="smt-backend"><a class="header" href="#smt-backend">SMT Backend</a></h1>
<p>The SMT backend for Act is currently able to automatically prove that:</p>
<ul>
<li>post conditions are implied by pre conditions</li>
<li>contract level invariants hold</li>
</ul>
<p>To perform these proofs, you can simply run <code>act prove --file &lt;PATH_TO_SPEC&gt;</code> against your spec.</p>
<p><code>act prove</code> also accepts the following configuration flags:</p>
<ul>
<li><code>--solver</code>: you can choose to use <code>cvc4</code> or <code>z3</code> as the solver backend. The default is <code>z3</code>.
Sometimes <code>cvc4</code> may be able to prove things that <code>z3</code> cannot (and vice versa). You can also
prove the same properties with multiple solvers to gain confidence that the proofs are not
affected by a bug in the solver itself.</li>
<li><code>--smttimeout</code>: the timeout given for each smt query. This is set to 20s by default.</li>
<li><code>--debug</code>: this prints the raw query dispatched to the SMT solver to stdout. Note that these
queries are machine generated by the <code>sbv</code> library and so are fairly challenging to inspect manually.</li>
</ul>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<h3 id="automatic-market-maker"><a class="header" href="#automatic-market-maker">Automatic Market Maker</a></h3>
<p>As an example consider the following specification of a simplified uniswap style automatic market
maker. For the purposes of this example we focus only on the core logic, and ignore e.g.
interactions with the underlying tokens.</p>
<p>The <code>Amm</code> has two state variables representing its underlying token balances, <code>reserve0</code> and
<code>reserve1</code>. These are initialized to <code>1000</code> units each upon creation.</p>
<p>We define a single invariant, that the product of the two reserves should never decrease. This is an
important safety property, if it is violated, an attacker will be able to execute a sequence of
trades that can drain all funds from the exchange.</p>
<pre><code class="language-act">behaviour init of Amm
interface constructor()

creates

    uint256 reserve0 := 1000
    uint256 reserve1 := 1000

invariants

    1000 * 1000 &lt;= reserve0 * reserve1
</code></pre>
<p>Next, we define the two <code>swap</code> methods, that allow a user to exchange tokens. These methods take an
amount (<code>amt</code>) of input reserves, and the <code>Amm</code> will adjust the size of the other reserve according
to the <code>x * y == k</code> constant product formula.</p>
<pre><code class="language-act">behaviour swap0 of Amm
interface swap0(uint256 amt)

iff in range uint256

    reserve0 + amt

storage

    reserve0 =&gt; reserve0 + amt
    reserve1 =&gt; (reserve0 * reserve1) / (reserve0 + amt)
</code></pre>
<pre><code class="language-act">behaviour swap1 of Amm
interface swap1(uint256 amt)

iff in range uint256

    reserve1 + amt

storage

    reserve0 =&gt; (reserve0 * reserve1) / (reserve1 + amt)
    reserve1 =&gt; reserve1 + amt
</code></pre>
<p>If we run <code>act prove</code> against the above spec, we find that there is in fact an error. If the <code>Amm</code>
starts with <code>reserve0 == 1</code> and <code>reserve1 == 1,000,000</code>, and <code>swap0</code> is called with <code>amt == 2</code>, the
final state of the <code>Amm</code> will be <code>reserve0 == 3</code> and <code>reserve1 == 333,333</code>. In this case <code>3 * 333,333</code> is <code>999,999</code>, and in fact the product of the reserves has decreased slightly due to
imprecision introduced by the EVM's flooring division.</p>
<p>A safe specification for the <code>swap</code> methods is as follows. Notice the extra <code>+1</code> added to the output
reserve in both cases. With this implementation, the rounding error is now in favor of the pool
instead of the trader, and the contract is now safe against this particular attack.</p>
<p>If we again run <code>act prove</code> against the fixed specification, we see that the invariant holds for all
possible executions of the contract.</p>
<pre><code class="language-act">behaviour swap0 of Amm
interface swap0(uint256 amt)

iff in range uint256

    reserve0 + amt

storage

    reserve0 =&gt; reserve0 + amt
    reserve1 =&gt; (reserve0 * reserve1) / (reserve0 + amt) + 1
</code></pre>
<pre><code class="language-act">behaviour swap1 of Amm
interface swap1(uint256 amt)

iff in range uint256

    reserve1 + amt

storage

    reserve0 =&gt; (reserve0 * reserve1) / (reserve1 + amt) + 1
    reserve1 =&gt; reserve1 + amt
</code></pre>
<h3 id="underpowered-invariant"><a class="header" href="#underpowered-invariant">Underpowered Invariant</a></h3>
<p>Due to the inductive nature of the proof, there are some true invariants that the SMT backend is
unable to prove. For example, consider the following state machine:</p>
<pre><code class="language-act">behaviour init of C
interface constructor()

creates
    uint x := 0

invariants
    x &lt; 9

behaviour f of C
interface f()

case x == 0:

    storage
        x =&gt; 1

behaviour g of C
interface g()

case x == 1:

    storage
        x =&gt; 2

behaviour j of C
interface j()

case x == 7:

    storage
        x =&gt; 100
</code></pre>
<p>The contract <code>C</code> can never be in a state were <code>x == 7</code> and so the write of <code>100</code> to <code>x</code> in <code>j()</code> can
never occur, however if we run <code>act prove</code> against this specification, this exact case (<code>x == 7</code>) is
found as a counterexample.</p>
<p>This is due to the inductive nature of the proof: <code>act</code> checks that the invariant holds after
running the constructor, and then for each method assumes that the invariant holds over the pre state
and checks that the invariant holds over the post state.</p>
<p>In the case above, the invariant states that <code>x &lt; 9</code>, and if this is assumed as a precondition, then
the <code>x == 7</code> branch in <code>j()</code> is still reachable.</p>
<p>We can fix this by strengthening the invariant to make the <code>x == 7</code> branch unreachable, in the case
of the spec above, an invariant of <code>x &lt; 7</code> is sufficient, although <code>x &lt; 3</code> is the strongest
invariant of this form that holds over the full transition system.</p>
<h2 id="limitations"><a class="header" href="#limitations">Limitations</a></h2>
<p>Although SMT solvers are powerful tools there are some important limitations to be aware of:</p>
<ul>
<li>The invariants proven can only be inductive in nature, and can only be expressed in terms of state
variables and constructor arguments.</li>
<li>SMT solvers do not support the exponentiation operation.</li>
<li>The solver may be unable to prove properties about behaviours making extensive use of non linear
arithmetic (i.e. multiplication or division by a symbolic value). This is an inherent limitation
of all SMT solvers.</li>
</ul>
<h2 id="implementation-strategy"><a class="header" href="#implementation-strategy">Implementation Strategy</a></h2>
<p>For each invariant claim, Act builds an individual SMT query for each behaviour in the transtion
system. If there are no invariant claims defined, then <code>act</code> will insert an implicit invariant of
<code>True</code>, meaning that the postconditions are still checked.</p>
<p>If the behaviour is a constructor, the query asks the solver to find instances where:</p>
<ul>
<li>the preconditions hold</li>
<li>the storage values in the poststate match those specified by the <code>creates</code> block of the constructor</li>
<li>the invariant does not hold over the post state or the postconditions do not hold over the poststate</li>
</ul>
<p>If the behaviour is a method, the query asks the solver to find instances where:</p>
<ul>
<li>the invariant holds over the pre state</li>
<li>the preconditions hold</li>
<li>all storage variables in the prestate are within the range specified by their type</li>
<li>a predicate relating the pre and post state according to the specification in the <code>storage</code> block holds</li>
<li>the invariant does not hold over the post state or the postconditions do not hold over the poststate</li>
</ul>
<p>If all of the queries for an invariant claim return <code>unsat</code>, then two properties have been proved
about the transition system:</p>
<ol>
<li>The invariant holds over the post state</li>
<li>The postconditions hold for every method level behaviour</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="backends.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="coq.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="backends.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="coq.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="mermaid.min.js"></script>
        
        <script type="text/javascript" src="mermaid-init.js"></script>
        

        

    </body>
</html>
