<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Internals - The Act Book</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="language.html"><strong aria-hidden="true">1.</strong> Language Reference</a></li><li class="chapter-item expanded "><a href="backends.html"><strong aria-hidden="true">2.</strong> Backends</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="smt.html"><strong aria-hidden="true">2.1.</strong> SMT</a></li><li class="chapter-item expanded "><a href="coq.html"><strong aria-hidden="true">2.2.</strong> Coq</a></li><li class="chapter-item expanded "><a href="hevm.html"><strong aria-hidden="true">2.3.</strong> Hevm</a></li></ol></li><li class="chapter-item expanded "><a href="internals.html" class="active"><strong aria-hidden="true">3.</strong> Internals</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Act Book</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="internals"><a class="header" href="#internals">Internals</a></h1>
<h2 id="the-act-ast-type"><a class="header" href="#the-act-ast-type">The Act AST Type</a></h2>
<p>All act specs are transformed into typed AST instances. The definition of this AST type can be found
in <a href="https://github.com/ethereum/act/blob/master/src/Syntax/TimeAgnostic.hs">Syntax/TimeAgnostic.hs</a>.</p>
<p>The top level datatype here is a <code>Claim</code>, and the output of the frontend states is a list of
(<code>Timed</code>) claims. A <code>Claim</code> is a sum type (enum) with four potential values:</p>
<ul>
<li><code>C</code>: constructor</li>
<li><code>B</code>: behaviour</li>
<li><code>I</code>: invariant</li>
<li><code>S</code>: typing information for storage variables</li>
</ul>
<h3 id="pass-and-fail-claims"><a class="header" href="#pass-and-fail-claims">Pass and Fail Claims</a></h3>
<p>Act specs are intended to be fully exhaustive, for this reason we generate two claims from each
constructor / behaviour in the spec:</p>
<ol>
<li><code>Pass</code>: The Pass claim states that if all preconditions in the iff block are true, then all executions will succeed, storage will be updated according to the storage block, and the specified return value will, in fact, be returned.</li>
<li><code>Fail</code>: The Fail claim states that should any of the preconditions be false, all executions will revert.</li>
</ol>
<p>Taken together a succesfull proof of these claims ensures that a given bytecode object implements
only the behaviour specified in act <em>and nothing else</em>.</p>
<h3 id="timed-vs-untimed-instances"><a class="header" href="#timed-vs-untimed-instances">Timed vs Untimed Instances</a></h3>
<p>AST instances can be either <code>Timed</code> (explicitly timed storage references) or <code>Untimed</code> (implicitly
timed storage references), and this distinction is reflected at the type level (the <code>t</code> parameter in
most of the data type definitions).</p>
<p>In some parts of an act spec (<code>returns</code> and <code>ensures</code> blocks), storage references must be qualified
with either the <code>pre</code> or <code>post</code> operator to disambiguate references to storage in the pre or post
state. In other blocks storage references are either implicitly refering to both pre and post states
(<code>invariants</code>), or to the pre state only (e.g. <code>storage</code>). In order to simplify implementation in
the various backends, there is a frontend stage (<code>annotate</code>) that makes all implicit timings
explicit. The type parameter allows us to enforce the invariant that all backend stages always
operate on <code>Timed</code>  AST instances.</p>
<h2 id="compilation-pipeline"><a class="header" href="#compilation-pipeline">Compilation Pipeline</a></h2>
<p>The act compilation pipeline is as follows:</p>
<pre class="mermaid">flowchart LR;
    Source --&gt; Lexer
    Lexer --&gt; Parser;
    Parser --&gt; Type[Type Checker];
    Type --&gt; Annotate;
    Annotate --&gt; Enrich;
    Enrich --&gt; SMT;
    Enrich --&gt; Coq;
    Enrich --&gt; Hevm;
    Enrich --&gt; K;
</pre>
<h3 id="lexer"><a class="header" href="#lexer">Lexer</a></h3>
<p>Converts the source code into a sequence of tokens that can be consumed by the parser. We use
<a href="https://www.haskell.org/alex/">alex</a> to generate a lexer from the specification in
<a href="https://github.com/ethereum/act/blob/master/src/Lex.x">Lex.x</a>.</p>
<h3 id="parser"><a class="header" href="#parser">Parser</a></h3>
<p>Parses a sequence of tokens into an untyped AST. We use <a href="https://www.haskell.org/happy/">happy</a> to
generate a parser from the specification in
<a href="https://github.com/ethereum/act/blob/master/src/Parse.y">Parse.y</a>. The untyped AST is defined in
<a href="https://github.com/ethereum/act/blob/master/src/Syntax/Untyped.hs">Syntax/Untyped.hs</a>.</p>
<h3 id="type-checker"><a class="header" href="#type-checker">Type Checker</a></h3>
<p>The type checker takes an untyped AST, checks that none of the typing rules are violated, and
produces a typed AST. The typechecker is defined in
<a href="https://github.com/ethereum/act/blob/master/src/Type.hs">Type.hs</a> and the core typed AST definition
is in
<a href="https://github.com/ethereum/act/blob/master/src/Syntax/TimeAgnostic.hs">Syntax/TimeAgnostic.hs</a>.
The meaning of the timing parameter to the AST is described below in
<a href="#timed-vs-untimed-ast-instances">Timed vs Untimed AST instances</a>.</p>
<h3 id="annotation"><a class="header" href="#annotation">Annotation</a></h3>
<p>The annotate stage makes any implicit timings explicit. This stage is implemented in
<a href="https://github.com/ethereum/act/blob/master/src/Syntax/Annotated.hs">Syntax/Annotated.hs</a>.</p>
<h3 id="enrichment"><a class="header" href="#enrichment">Enrichment</a></h3>
<p>The enrich stage adds preconditions to all behaviour / constructor / invariant instances based on
the types of all variable references. This staged is implemented in
<a href="https://github.com/ethereum/act/blob/master/src/Enrich.hs">Enrich.hs</a>.</p>
<h2 id="error-handling"><a class="header" href="#error-handling">Error Handling</a></h2>
<p>Stages that need to present errors to the user should return an instance of the <code>Error</code> type defined
in <a href="https://github.com/ethereum/act/blob/master/src/Error.hs">Error.hs</a>. This is a modified instance
of <a href="https://hackage.haskell.org/package/validation-1.1.2">Data.Validation</a> specialised to the act
context. This type allows us to accumulate multiple error messsages (useful if e.g. multiple syntax
errors are present), and we also have unified routines to pretty print these messages.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="hevm.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="hevm.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="mermaid.min.js"></script>
        
        <script type="text/javascript" src="mermaid-init.js"></script>
        

        

    </body>
</html>
